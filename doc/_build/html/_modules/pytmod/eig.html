<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>pytmod.eig - pytmod</title><link rel="shortcut icon" href="../../_static/favicon.ico"/><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=10d1008b" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=bf552558" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="pytmod.eig"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      <img class="light-logo" src="../../_static/pytmod.svg" alt="pytmod" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/pytmod.svg" alt="pytmod" height="28" loading="lazy" />
      <strong>pytmod</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/benvial/pytmod" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/plot_slab.html">Slab</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../biblio.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../autoapi/pytmod/index.html">pytmod</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pytmod/eig/index.html">pytmod.eig</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pytmod/helpers/index.html">pytmod.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pytmod/material/index.html">pytmod.material</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pytmod/slab/index.html">pytmod.slab</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6"><div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">pytmod</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">pytmod.eig</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for pytmod.eig</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="ch">#!/usr/bin/env python</span>
</span><span data-line="2"><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span data-line="3"><span class="c1"># Authors: Benjamin Vial</span>
</span><span data-line="4"><span class="c1"># This file is part of pytmod</span>
</span><span data-line="5"><span class="c1"># License: GPLv3</span>
</span><span data-line="6"><span class="c1"># See the documentation at bvial.info/pytmod</span>
</span><span data-line="7">
</span><span data-line="8"><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nonlinear_eigensolver&quot;</span><span class="p">]</span>
</span><span data-line="9">
</span><span data-line="10"><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span data-line="11"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span data-line="12">
</span><span data-line="13"><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
</span><span data-line="14"><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span data-line="15"><span class="kn">import</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">la</span>
</span><span data-line="16"><span class="kn">from</span><span class="w"> </span><span class="nn">skimage.feature</span><span class="w"> </span><span class="kn">import</span> <span class="n">peak_local_max</span>
</span><span data-line="17">
</span><span data-line="18"><span class="c1"># from numdiff import backend as bk</span>
</span><span data-line="19"><span class="c1"># from numdiff import get_backend</span>
</span><span data-line="20">
</span><span data-line="21">
</span><span data-line="22"><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bk</span>
</span><span data-line="23"><span class="k">def</span><span class="w"> </span><span class="nf">get_backend</span><span class="p">():</span>
</span><span data-line="24">    <span class="k">return</span> <span class="s2">&quot;numpy&quot;</span>
</span><span data-line="25">
</span><span data-line="26">
</span><span data-line="27"><span class="k">def</span><span class="w"> </span><span class="nf">cut_in_four</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">ratio_re</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ratio_im</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span data-line="28">    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">z1</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">z0</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">z1</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="29">    <span class="n">xm</span><span class="p">,</span> <span class="n">ym</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">ratio_re</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">),</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ratio_im</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>
</span><span data-line="30">    <span class="n">zm</span> <span class="o">=</span> <span class="n">xm</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">ym</span>
</span><span data-line="31">    <span class="n">zb</span> <span class="o">=</span> <span class="n">xm</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">y0</span>
</span><span data-line="32">    <span class="n">zt</span> <span class="o">=</span> <span class="n">xm</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">y1</span>
</span><span data-line="33">    <span class="n">zl</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">ym</span>
</span><span data-line="34">    <span class="n">zr</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">ym</span>
</span><span data-line="35">    <span class="k">return</span> <span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">zm</span><span class="p">),</span> <span class="p">(</span><span class="n">zb</span><span class="p">,</span> <span class="n">zr</span><span class="p">),</span> <span class="p">(</span><span class="n">zm</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">zl</span><span class="p">,</span> <span class="n">zt</span><span class="p">)</span>
</span><span data-line="36">
</span><span data-line="37">
</span><span data-line="38"><span class="k">def</span><span class="w"> </span><span class="nf">get_residual</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
</span><span data-line="39"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="40"><span class="sd">    Compute the residual of the eigenvalue problem M @ phi = 0.</span>
</span><span data-line="41">
</span><span data-line="42"><span class="sd">    Parameters</span>
</span><span data-line="43"><span class="sd">    ----------</span>
</span><span data-line="44"><span class="sd">    M : array</span>
</span><span data-line="45"><span class="sd">        The matrix of the eigenvalue problem</span>
</span><span data-line="46"><span class="sd">    phi : array</span>
</span><span data-line="47"><span class="sd">        The eigenvector</span>
</span><span data-line="48">
</span><span data-line="49"><span class="sd">    Returns</span>
</span><span data-line="50"><span class="sd">    -------</span>
</span><span data-line="51"><span class="sd">    float</span>
</span><span data-line="52"><span class="sd">        The norm of the residual</span>
</span><span data-line="53"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="54">
</span><span data-line="55">    <span class="k">return</span> <span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span> <span class="o">@</span> <span class="n">M</span> <span class="o">@</span> <span class="n">phi</span><span class="p">)</span>
</span><span data-line="56">
</span><span data-line="57">
</span><span data-line="58"><span class="k">def</span><span class="w"> </span><span class="nf">eig</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span data-line="59"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="60"><span class="sd">    Solve the eigenvalue problem C @ phi = D @ phi * omega.</span>
</span><span data-line="61">
</span><span data-line="62"><span class="sd">    Parameters</span>
</span><span data-line="63"><span class="sd">    ----------</span>
</span><span data-line="64"><span class="sd">    C : array</span>
</span><span data-line="65"><span class="sd">        The matrix of the eigenvalue problem</span>
</span><span data-line="66"><span class="sd">    D : array</span>
</span><span data-line="67"><span class="sd">        The matrix of the eigenvalue problem</span>
</span><span data-line="68">
</span><span data-line="69"><span class="sd">    Returns</span>
</span><span data-line="70"><span class="sd">    -------</span>
</span><span data-line="71"><span class="sd">    omega : array</span>
</span><span data-line="72"><span class="sd">        The eigenvalues</span>
</span><span data-line="73"><span class="sd">    phi : array</span>
</span><span data-line="74"><span class="sd">        The eigenvectors</span>
</span><span data-line="75"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="76">    <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="77">        <span class="n">invD</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</span><span data-line="78">        <span class="k">return</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">invD</span> <span class="o">@</span> <span class="n">C</span><span class="p">)</span>
</span><span data-line="79">    <span class="k">return</span> <span class="n">la</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="80">
</span><span data-line="81">
</span><span data-line="82"><span class="k">class</span><span class="w"> </span><span class="nc">ConvergenceError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span data-line="83">    <span class="k">pass</span>
</span><span data-line="84">
</span><span data-line="85">
</span><span data-line="86"><span class="k">class</span><span class="w"> </span><span class="nc">EigenvalueError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span data-line="87">    <span class="k">pass</span>
</span><span data-line="88">
</span><span data-line="89">
</span><span data-line="90"><span class="k">def</span><span class="w"> </span><span class="nf">null</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span data-line="91"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="92"><span class="sd">    Compute the nullspace of a matrix M.</span>
</span><span data-line="93">
</span><span data-line="94"><span class="sd">    Parameters</span>
</span><span data-line="95"><span class="sd">    ----------</span>
</span><span data-line="96"><span class="sd">    M : array</span>
</span><span data-line="97"><span class="sd">        The matrix</span>
</span><span data-line="98"><span class="sd">    mult : int, optional</span>
</span><span data-line="99"><span class="sd">        The multiplicity of the nullspace</span>
</span><span data-line="100">
</span><span data-line="101"><span class="sd">    Returns</span>
</span><span data-line="102"><span class="sd">    -------</span>
</span><span data-line="103"><span class="sd">    array</span>
</span><span data-line="104"><span class="sd">        The nullspace of M</span>
</span><span data-line="105"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="106">    <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</span><span data-line="107">    <span class="n">srt</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span data-line="108">    <span class="k">return</span> <span class="n">v</span><span class="p">[:,</span> <span class="n">srt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">mult</span><span class="p">]]</span>
</span><span data-line="109">
</span><span data-line="110">
</span><span data-line="111"><span class="k">def</span><span class="w"> </span><span class="nf">block</span><span class="p">(</span><span class="n">matrices</span><span class="p">):</span>
</span><span data-line="112"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="113"><span class="sd">    Stack a list of matrices into a single matrix.</span>
</span><span data-line="114">
</span><span data-line="115"><span class="sd">    Parameters</span>
</span><span data-line="116"><span class="sd">    ----------</span>
</span><span data-line="117"><span class="sd">    matrices : list of arrays</span>
</span><span data-line="118"><span class="sd">        The matrices to stack</span>
</span><span data-line="119">
</span><span data-line="120"><span class="sd">    Returns</span>
</span><span data-line="121"><span class="sd">    -------</span>
</span><span data-line="122"><span class="sd">    array</span>
</span><span data-line="123"><span class="sd">        The stacked matrix</span>
</span><span data-line="124"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="125">    <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="126">        <span class="k">return</span> <span class="n">bk</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">bk</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="127">    <span class="k">return</span> <span class="n">bk</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">matrices</span><span class="p">)</span>
</span><span data-line="128">
</span><span data-line="129">
</span><span data-line="130"><span class="k">def</span><span class="w"> </span><span class="nf">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span data-line="131"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="132"><span class="sd">    Compute the dot product of two arrays, either with torch.matmul or numpy.dot.</span>
</span><span data-line="133">
</span><span data-line="134"><span class="sd">    Parameters</span>
</span><span data-line="135"><span class="sd">    ----------</span>
</span><span data-line="136"><span class="sd">    a : array</span>
</span><span data-line="137"><span class="sd">        The first array</span>
</span><span data-line="138"><span class="sd">    b : array</span>
</span><span data-line="139"><span class="sd">        The second array</span>
</span><span data-line="140">
</span><span data-line="141"><span class="sd">    Returns</span>
</span><span data-line="142"><span class="sd">    -------</span>
</span><span data-line="143"><span class="sd">    array</span>
</span><span data-line="144"><span class="sd">        The dot product of a and b</span>
</span><span data-line="145"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="146">    <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="147">        <span class="k">return</span> <span class="n">bk</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span data-line="148">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="149">        <span class="k">return</span> <span class="n">bk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span data-line="150">
</span><span data-line="151">
</span><span data-line="152"><span class="c1"># adapted from https://github.com/DavidPowell/OpenModes/blob/161bd0b30036c98caf4ab0cd463032a4ba22a382/openmodes/eig.py#L193</span>
</span><span data-line="153">
</span><span data-line="154">
</span><span data-line="155"><span class="k">def</span><span class="w"> </span><span class="nf">eig_newton</span><span class="p">(</span>
</span><span data-line="156">    <span class="n">func</span><span class="p">,</span>
</span><span data-line="157">    <span class="n">lambda_0</span><span class="p">,</span>
</span><span data-line="158">    <span class="n">x_0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="159">    <span class="n">lambda_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
</span><span data-line="160">    <span class="n">max_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span data-line="161">    <span class="n">func_gives_der</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="162">    <span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="163">    <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
</span><span data-line="164">    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;rayleigh symmetric&quot;</span><span class="p">,</span>
</span><span data-line="165">    <span class="n">y_0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="166"><span class="p">):</span>
</span><span data-line="167"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve a nonlinear eigenvalue problem by Newton iteration</span>
</span><span data-line="168">
</span><span data-line="169"><span class="sd">    Parameters</span>
</span><span data-line="170"><span class="sd">    ----------</span>
</span><span data-line="171"><span class="sd">    func : function</span>
</span><span data-line="172"><span class="sd">        The function with input `lambda` which returns the matrix</span>
</span><span data-line="173"><span class="sd">    lambda_0 : complex</span>
</span><span data-line="174"><span class="sd">        The starting guess for the eigenvalue</span>
</span><span data-line="175"><span class="sd">    x_0 : ndarray</span>
</span><span data-line="176"><span class="sd">        The starting guess for the eigenvector</span>
</span><span data-line="177"><span class="sd">    lambda_tol : float</span>
</span><span data-line="178"><span class="sd">        The relative tolerance in the eigenvalue for convergence</span>
</span><span data-line="179"><span class="sd">    max_iter : int</span>
</span><span data-line="180"><span class="sd">        The maximum number of iterations to perform</span>
</span><span data-line="181"><span class="sd">    func_gives_der : boolean, optional</span>
</span><span data-line="182"><span class="sd">        If `True`, then the function also returns the derivative as the second</span>
</span><span data-line="183"><span class="sd">        returned value. If `False` finite differences will be used instead,</span>
</span><span data-line="184"><span class="sd">        which will have reduced accuracy</span>
</span><span data-line="185"><span class="sd">    args : list, optional</span>
</span><span data-line="186"><span class="sd">        Any additional arguments to be supplied to `func`</span>
</span><span data-line="187"><span class="sd">    weight : string, optional</span>
</span><span data-line="188"><span class="sd">        How to perform the weighting of the eigenvector</span>
</span><span data-line="189">
</span><span data-line="190"><span class="sd">        &#39;max element&#39; : The element with largest magnitude will be preserved</span>
</span><span data-line="191">
</span><span data-line="192"><span class="sd">        &#39;rayleigh&#39; : Rayleigh iteration for Hermitian matrices will be used</span>
</span><span data-line="193">
</span><span data-line="194"><span class="sd">        &#39;rayleigh symmetric&#39; : Rayleigh iteration for complex symmetric</span>
</span><span data-line="195"><span class="sd">        (i.e. non-Hermitian) matrices will be used</span>
</span><span data-line="196">
</span><span data-line="197"><span class="sd">        &#39;rayleigh asymmetric&#39; : Rayleigh iteration for general matrices</span>
</span><span data-line="198">
</span><span data-line="199"><span class="sd">    y_0 : ndarray, optional</span>
</span><span data-line="200"><span class="sd">        For &#39;rayleigh asymmetric weighting&#39;, this is required as the initial</span>
</span><span data-line="201"><span class="sd">        guess for the left eigenvector</span>
</span><span data-line="202">
</span><span data-line="203"><span class="sd">    Returns</span>
</span><span data-line="204"><span class="sd">    -------</span>
</span><span data-line="205"><span class="sd">    res : dictionary</span>
</span><span data-line="206"><span class="sd">        A dictionary containing the following members:</span>
</span><span data-line="207">
</span><span data-line="208"><span class="sd">        `eigval` : the eigenvalue</span>
</span><span data-line="209">
</span><span data-line="210"><span class="sd">        &#39;eigvec&#39; : the eigenvector</span>
</span><span data-line="211">
</span><span data-line="212"><span class="sd">        &#39;iter_count&#39; : the number of iterations performed</span>
</span><span data-line="213">
</span><span data-line="214"><span class="sd">        &#39;delta_lambda&#39; : the change in the eigenvalue on the final iteration</span>
</span><span data-line="215">
</span><span data-line="216">
</span><span data-line="217"><span class="sd">    See:</span>
</span><span data-line="218"><span class="sd">    1.  P. Lancaster, Lambda Matrices and Vibrating Systems.</span>
</span><span data-line="219"><span class="sd">        Oxford: Pergamon, 1966.</span>
</span><span data-line="220">
</span><span data-line="221"><span class="sd">    2.  A. Ruhe, “Algorithms for the Nonlinear Eigenvalue Problem,”</span>
</span><span data-line="222"><span class="sd">        SIAM J. Numer. Anal., vol. 10, no. 4, pp. 674–689, Sep. 1973.</span>
</span><span data-line="223">
</span><span data-line="224"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="225">
</span><span data-line="226">    <span class="c1"># import time</span>
</span><span data-line="227">    <span class="c1"># import numpy as np</span>
</span><span data-line="228">    <span class="c1"># t = -time.time()</span>
</span><span data-line="229">
</span><span data-line="230">    <span class="n">has_y_0</span> <span class="o">=</span> <span class="n">y_0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="231">    <span class="n">has_x_0</span> <span class="o">=</span> <span class="n">x_0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="232">    <span class="n">x_s</span> <span class="o">=</span> <span class="n">x_0</span>
</span><span data-line="233">    <span class="n">lambda_s</span> <span class="o">=</span> <span class="n">lambda_0</span>
</span><span data-line="234">
</span><span data-line="235">    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for zeros with eig_newton&quot;</span><span class="p">)</span>
</span><span data-line="236">    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting guess </span><span class="si">%+.4e</span><span class="s2"> </span><span class="si">%+.4e</span><span class="s2">j&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lambda_0</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">lambda_0</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span>
</span><span data-line="237">
</span><span data-line="238">    <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="239">
</span><span data-line="240">    <span class="k">if</span> <span class="ow">not</span> <span class="n">func_gives_der</span><span class="p">:</span>
</span><span data-line="241">        <span class="c1"># evaluate at an arbitrary nearby starting point to allow finite</span>
</span><span data-line="242">        <span class="c1"># differences to be taken</span>
</span><span data-line="243">        <span class="n">step</span> <span class="o">=</span> <span class="n">lambda_tol</span> <span class="o">*</span> <span class="mi">10</span>
</span><span data-line="244">        <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span data-line="245">        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
</span><span data-line="246">        <span class="c1"># lambda_sm = lambda_0 * (1 + (1 + 1j) * step)</span>
</span><span data-line="247">        <span class="n">lambda_sm</span> <span class="o">=</span> <span class="n">lambda_0</span> <span class="o">+</span> <span class="n">step</span>
</span><span data-line="248">        <span class="n">T_sm</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lambda_sm</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span data-line="249">
</span><span data-line="250">    <span class="c1"># lambda_history = [lambda_s]</span>
</span><span data-line="251">    <span class="c1"># plt.plot(lambda_s.real,lambda_s.imag,&quot;xk&quot;)</span>
</span><span data-line="252">    <span class="c1"># plt.xlim(0.2,1.3)</span>
</span><span data-line="253">    <span class="c1"># plt.ylim(-0.3,-0.0)</span>
</span><span data-line="254">
</span><span data-line="255">    <span class="k">for</span> <span class="n">iter_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
</span><span data-line="256">        <span class="k">if</span> <span class="n">func_gives_der</span><span class="p">:</span>
</span><span data-line="257">            <span class="n">T_s</span><span class="p">,</span> <span class="n">T_ds</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lambda_s</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span data-line="258">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="259">            <span class="n">T_s</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lambda_s</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span data-line="260">            <span class="n">T_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_s</span> <span class="o">-</span> <span class="n">T_sm</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lambda_s</span> <span class="o">-</span> <span class="n">lambda_sm</span><span class="p">)</span>
</span><span data-line="261">
</span><span data-line="262">        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_x_0</span> <span class="ow">and</span> <span class="n">iter_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="263">            <span class="n">x_s</span> <span class="o">=</span> <span class="n">null</span><span class="p">(</span><span class="n">T_s</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span data-line="264">            <span class="n">x_s</span> <span class="o">/=</span> <span class="p">(</span><span class="n">x_s</span> <span class="o">@</span> <span class="n">T_ds</span> <span class="o">@</span> <span class="n">x_s</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</span><span data-line="265">
</span><span data-line="266">        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_y_0</span> <span class="ow">and</span> <span class="n">iter_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">weight</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rayleigh asymmetric&quot;</span><span class="p">:</span>
</span><span data-line="267">            <span class="n">y_s</span> <span class="o">=</span> <span class="n">null</span><span class="p">(</span><span class="n">T_s</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span data-line="268">            <span class="n">y_s</span> <span class="o">/=</span> <span class="p">(</span><span class="n">y_s</span> <span class="o">@</span> <span class="n">T_ds</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y_s</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</span><span data-line="269">
</span><span data-line="270">        <span class="n">w</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_ds</span><span class="p">,</span> <span class="n">x_s</span><span class="p">)</span>
</span><span data-line="271">        <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="272">            <span class="c1"># import torch</span>
</span><span data-line="273">            <span class="c1"># A = torch.ones(3,3)</span>
</span><span data-line="274">            <span class="c1"># A_LU, pivots, info = torch.linalg.lu_factor_ex(A, check_errors=False)</span>
</span><span data-line="275">            <span class="c1"># A_LU_solvable = A_LU[info != 0]</span>
</span><span data-line="276">            <span class="c1"># pivots_solvable = A_LU[info != 0]</span>
</span><span data-line="277">            <span class="c1"># X = torch.linalg.lu_solve(B, A_LU_solvable, pivots_solvable)</span>
</span><span data-line="278">
</span><span data-line="279">            <span class="n">T_s_lu</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_factor_ex</span><span class="p">(</span><span class="n">T_s</span><span class="p">,</span> <span class="n">check_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="280">            <span class="c1"># T_s_lu = bk.linalg.lu_factor(T_s)</span>
</span><span data-line="281">            <span class="n">u</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span><span class="o">*</span><span class="n">T_s_lu</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">bk</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">w</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span data-line="282">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="283">            <span class="n">T_s_lu</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">lu_factor</span><span class="p">(</span><span class="n">T_s</span><span class="p">)</span>
</span><span data-line="284">            <span class="n">u</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span><span class="n">T_s_lu</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span data-line="285">            <span class="c1"># u = la.solve(T_s, dot(T_ds, x_s))</span>
</span><span data-line="286">
</span><span data-line="287">        <span class="c1"># if known_vects is supplied, we should take this into account when</span>
</span><span data-line="288">        <span class="c1"># finding v</span>
</span><span data-line="289">        <span class="k">if</span> <span class="n">weight</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;max element&quot;</span><span class="p">:</span>
</span><span data-line="290">            <span class="n">v_s</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_s</span><span class="p">)</span>
</span><span data-line="291">            <span class="n">v_s</span><span class="p">[</span><span class="n">bk</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_s</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span data-line="292">        <span class="k">elif</span> <span class="n">weight</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rayleigh&quot;</span><span class="p">:</span>
</span><span data-line="293">            <span class="n">v_s</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x_s</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
</span><span data-line="294">        <span class="k">elif</span> <span class="n">weight</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rayleigh symmetric&quot;</span><span class="p">:</span>
</span><span data-line="295">            <span class="n">v_s</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x_s</span><span class="p">)</span>
</span><span data-line="296">        <span class="k">elif</span> <span class="n">weight</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rayleigh asymmetric&quot;</span><span class="p">:</span>
</span><span data-line="297">            <span class="n">w</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_ds</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y_s</span><span class="p">)</span>
</span><span data-line="298">
</span><span data-line="299">            <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="300">                <span class="n">y_s</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span>
</span><span data-line="301">                    <span class="o">*</span><span class="n">T_s_lu</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">bk</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">w</span><span class="p">]),</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span>
</span><span data-line="302">                <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span data-line="303">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="304">                <span class="n">y_s</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span><span class="n">T_s_lu</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="305">            <span class="c1"># y_s = bk.linalg.lu_solve(T_s_lu, dot(T_ds.T, y_s), trans=1)</span>
</span><span data-line="306">            <span class="n">y_s</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_s</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> 
</span><span data-line="307">            <span class="n">v_s</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y_s</span><span class="p">)</span>
</span><span data-line="308">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="309">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown weighting method </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">weight</span><span class="p">)</span>
</span><span data-line="310">
</span><span data-line="311">        <span class="n">delta_lambda_abs</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v_s</span><span class="p">,</span> <span class="n">x_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">dot</span><span class="p">(</span><span class="n">v_s</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</span><span data-line="312">
</span><span data-line="313">        <span class="n">delta_lambda</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_lambda_abs</span> <span class="o">/</span> <span class="n">lambda_s</span><span class="p">)</span>
</span><span data-line="314">        <span class="n">converged</span> <span class="o">=</span> <span class="n">delta_lambda</span> <span class="o">&lt;</span> <span class="n">lambda_tol</span>
</span><span data-line="315">
</span><span data-line="316">        <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
</span><span data-line="317">            <span class="k">break</span>
</span><span data-line="318">
</span><span data-line="319">        <span class="n">lambda_s1</span> <span class="o">=</span> <span class="n">lambda_s</span> <span class="o">-</span> <span class="n">delta_lambda_abs</span>
</span><span data-line="320">        <span class="n">x_s1</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">bk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span><span data-line="321">        <span class="n">x_s1</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span> <span class="o">@</span> <span class="n">T_ds</span> <span class="o">@</span> <span class="n">u</span><span class="p">)</span>
</span><span data-line="322">
</span><span data-line="323">        <span class="c1"># update variables for next iteration</span>
</span><span data-line="324">        <span class="k">if</span> <span class="ow">not</span> <span class="n">func_gives_der</span><span class="p">:</span>
</span><span data-line="325">            <span class="n">lambda_sm</span> <span class="o">=</span> <span class="n">lambda_s</span>
</span><span data-line="326">            <span class="n">T_sm</span> <span class="o">=</span> <span class="n">T_s</span>
</span><span data-line="327">
</span><span data-line="328">        <span class="n">lambda_s</span> <span class="o">=</span> <span class="n">lambda_s1</span>
</span><span data-line="329">        <span class="n">x_s</span> <span class="o">=</span> <span class="n">x_s1</span>
</span><span data-line="330">
</span><span data-line="331">        <span class="c1"># if not has_x_0 and iter_count==0:</span>
</span><span data-line="332">        <span class="c1">#     _u = null(T_s)[:, 0]</span>
</span><span data-line="333">        <span class="c1">#     x_s +=  _u/ bk.sqrt(bk.sum(bk.abs(u) ** 2))</span>
</span><span data-line="334">        <span class="c1">#     x_s /= 2</span>
</span><span data-line="335">        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%+.4e</span><span class="s2"> </span><span class="si">%+.4e</span><span class="s2">j&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lambda_s</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">lambda_s</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span>
</span><span data-line="336">
</span><span data-line="337">        <span class="c1"># if iter_count&gt;0:</span>
</span><span data-line="338">        <span class="c1">#     line_cur[0].remove()</span>
</span><span data-line="339">        <span class="c1">#     pnt_cur[0].remove()</span>
</span><span data-line="340">    <span class="c1">#     lambda_history.append(lambda_s)</span>
</span><span data-line="341">    <span class="c1">#     pnt_cur = plt.plot(lambda_s.real,lambda_s.imag,&quot;ob&quot;,ms=5)</span>
</span><span data-line="342">    <span class="c1">#     hst = np.array(lambda_history)</span>
</span><span data-line="343">    <span class="c1">#     line_cur = plt.plot(hst.real,hst.imag,&quot;-ob&quot;,alpha=0.2,ms=5)</span>
</span><span data-line="344">    <span class="c1">#     # plt.pause(0.2)</span>
</span><span data-line="345">
</span><span data-line="346">    <span class="c1"># t += time.time()</span>
</span><span data-line="347">    <span class="c1"># print(f&quot;elapsed time {t:0.4f}s&quot;)</span>
</span><span data-line="348">    <span class="c1"># print(f&quot;{iter_count} iterations&quot;)</span>
</span><span data-line="349">    <span class="c1"># print(lambda_s)</span>
</span><span data-line="350">    <span class="c1"># # case = &quot;random&quot; if x_0 is not None else &quot;eig&quot;</span>
</span><span data-line="351">    <span class="c1"># # np.savez(f&quot;/home/bench/doc/data/tmp_{case}.npz&quot;,lambda_history=lambda_history)</span>
</span><span data-line="352">
</span><span data-line="353">    <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
</span><span data-line="354">        <span class="c1"># return</span>
</span><span data-line="355">        <span class="k">raise</span> <span class="n">ConvergenceError</span><span class="p">(</span><span class="s2">&quot;maximum iterations reached, no convergence&quot;</span><span class="p">)</span>
</span><span data-line="356">        <span class="k">return</span>
</span><span data-line="357">
</span><span data-line="358">    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="359">        <span class="s2">&quot;eigval&quot;</span><span class="p">:</span> <span class="n">lambda_s</span><span class="p">,</span>
</span><span data-line="360">        <span class="s2">&quot;iter_count&quot;</span><span class="p">:</span> <span class="n">iter_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span data-line="361">        <span class="s2">&quot;delta_lambda&quot;</span><span class="p">:</span> <span class="n">delta_lambda</span><span class="p">,</span>
</span><span data-line="362">    <span class="p">}</span>
</span><span data-line="363">
</span><span data-line="364">    <span class="k">if</span> <span class="n">weight</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rayleigh asymmetric&quot;</span><span class="p">:</span>
</span><span data-line="365">        <span class="c1"># Scale both the left and right eigenvector identically first</span>
</span><span data-line="366">        <span class="n">y_s</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">bk</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">x_s</span><span class="p">))</span>
</span><span data-line="367">
</span><span data-line="368">        <span class="c1"># Then scale both to match the eigenvalue derivative</span>
</span><span data-line="369">        <span class="n">dz_ds</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_ds</span><span class="p">,</span> <span class="n">x_s</span><span class="p">))</span>
</span><span data-line="370">        <span class="n">y_s</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dz_ds</span><span class="p">)</span>
</span><span data-line="371">        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigvec_left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_s</span>
</span><span data-line="372">
</span><span data-line="373">        <span class="n">x_s</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dz_ds</span><span class="p">)</span>
</span><span data-line="374">        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigvec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_s</span>
</span><span data-line="375">
</span><span data-line="376">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="377">        <span class="c1"># scale the eigenvector so that the eigenvalue derivative is 1</span>
</span><span data-line="378">        <span class="n">dz_ds</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">T_ds</span><span class="p">,</span> <span class="n">x_s</span><span class="p">))</span>
</span><span data-line="379">        <span class="n">x_s</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dz_ds</span><span class="p">)</span>
</span><span data-line="380">        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigvec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_s</span>
</span><span data-line="381">        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigvec_left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_s</span>
</span><span data-line="382">
</span><span data-line="383">    <span class="k">return</span> <span class="n">res</span>
</span><span data-line="384">
</span><span data-line="385">
</span><span data-line="386"><span class="n">_bounds_im</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="387">
</span><span data-line="388">
</span><span data-line="389"><span class="k">def</span><span class="w"> </span><span class="nf">_nonlinear_eigensolver</span><span class="p">(</span>
</span><span data-line="390">    <span class="n">func</span><span class="p">,</span>
</span><span data-line="391">    <span class="n">omega0</span><span class="p">,</span>
</span><span data-line="392">    <span class="n">omega1</span><span class="p">,</span>
</span><span data-line="393">    <span class="n">dfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="394">    <span class="n">guesses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="395">    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;max element&quot;</span><span class="p">,</span>
</span><span data-line="396">    <span class="n">init_vect</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span>
</span><span data-line="397">    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;peaks&quot;</span><span class="p">,</span>
</span><span data-line="398">    <span class="n">peaks_estimate</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span>
</span><span data-line="399">    <span class="n">lambda_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
</span><span data-line="400">    <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span data-line="401">    <span class="n">N_grid</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
</span><span data-line="402">    <span class="n">N_guess_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span data-line="403">    <span class="n">Rloc</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span data-line="404">    <span class="n">plot_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="405">    <span class="n">peak_ref</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span data-line="406">    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="407">    <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="408">    <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="409">    <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="410">    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="411"><span class="p">):</span>
</span><span data-line="412">    <span class="n">return_left</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;return_left&quot;</span><span class="p">]</span>
</span><span data-line="413">    <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="414">        <span class="n">weight</span> <span class="o">=</span> <span class="s2">&quot;rayleigh asymmetric&quot;</span>
</span><span data-line="415">    <span class="k">global</span> <span class="n">_bounds_im</span>
</span><span data-line="416">    <span class="n">tnlevp</span> <span class="o">=</span> <span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="417">    <span class="n">Nguess_re</span><span class="p">,</span> <span class="n">Nguess_im</span> <span class="o">=</span> <span class="n">N_grid</span>
</span><span data-line="418">
</span><span data-line="419">    <span class="n">Nre</span><span class="p">,</span> <span class="n">Nim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Nguess_re</span> <span class="o">*</span> <span class="n">peak_ref</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">Nguess_im</span> <span class="o">*</span> <span class="n">peak_ref</span><span class="p">)</span>
</span><span data-line="420">
</span><span data-line="421">    <span class="n">func_gives_der</span> <span class="o">=</span> <span class="n">dfunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="422">
</span><span data-line="423">    <span class="k">if</span> <span class="n">func_gives_der</span><span class="p">:</span>
</span><span data-line="424">
</span><span data-line="425">        <span class="k">def</span><span class="w"> </span><span class="nf">func_eig</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
</span><span data-line="426">            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">dfunc</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
</span><span data-line="427">
</span><span data-line="428">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="429">
</span><span data-line="430">        <span class="k">def</span><span class="w"> </span><span class="nf">func_eig</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
</span><span data-line="431">            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
</span><span data-line="432">
</span><span data-line="433">    <span class="k">if</span> <span class="n">guesses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="434">        <span class="n">guesses_re</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">omega0</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">omega1</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">Nre</span><span class="p">)</span>
</span><span data-line="435">        <span class="n">guesses_im</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">omega0</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">omega1</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">Nim</span><span class="p">)</span>
</span><span data-line="436">        <span class="n">guesses_re</span><span class="p">,</span> <span class="n">guesses_im</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">guesses_re</span><span class="p">,</span> <span class="n">guesses_im</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span data-line="437">        <span class="n">guesses</span> <span class="o">=</span> <span class="n">guesses_re</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">guesses_im</span>
</span><span data-line="438">        <span class="n">guesses0</span> <span class="o">=</span> <span class="n">guesses</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span data-line="439">        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
</span><span data-line="440">            <span class="n">guesses</span> <span class="o">=</span> <span class="n">guesses0</span>
</span><span data-line="441">        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;peaks&quot;</span><span class="p">:</span>
</span><span data-line="442">            <span class="n">omegas_re</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">omega0</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">omega1</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">Nre</span><span class="p">)</span>
</span><span data-line="443">            <span class="n">omegas_im</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">omega1</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">omega0</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">Nim</span><span class="p">)</span>
</span><span data-line="444">            <span class="n">omegas_re_</span><span class="p">,</span> <span class="n">omegas_im_</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">omegas_re</span><span class="p">,</span> <span class="n">omegas_im</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
</span><span data-line="445">
</span><span data-line="446">            <span class="c1">#################################################################</span>
</span><span data-line="447">            <span class="c1"># Compute complex plane quantities</span>
</span><span data-line="448">
</span><span data-line="449">            <span class="n">omegas_complex</span> <span class="o">=</span> <span class="n">omegas_re_</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">omegas_im_</span>
</span><span data-line="450">            <span class="n">Mc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">omegas_complex</span><span class="p">)</span>
</span><span data-line="451">            <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="452">                <span class="n">Mc</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">Mc</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span data-line="453">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="454">                <span class="n">Mc</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mc</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span data-line="455">            <span class="k">if</span> <span class="n">peaks_estimate</span><span class="o">==</span> <span class="s2">&quot;eig&quot;</span><span class="p">:</span>
</span><span data-line="456">                <span class="n">evs</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">Mc</span><span class="p">)</span>
</span><span data-line="457">                <span class="n">srt</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">evs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="458">                <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="459">                    <span class="n">min_evs</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">evs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">srt</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span data-line="460">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="461">                    <span class="n">min_evs</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">evs</span><span class="p">,</span> <span class="n">srt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span data-line="462">
</span><span data-line="463">                <span class="n">im</span> <span class="o">=</span> <span class="o">-</span><span class="n">bk</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_evs</span><span class="p">))</span>
</span><span data-line="464">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="465">                <span class="n">im</span> <span class="o">=</span> <span class="o">-</span><span class="n">bk</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Mc</span><span class="p">)))</span>
</span><span data-line="466">            <span class="k">if</span> <span class="n">plot_solver</span><span class="p">:</span>
</span><span data-line="467">                <span class="k">if</span> <span class="n">_bounds_im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="468">                    <span class="c1"># vmin = bk.min(im)</span>
</span><span data-line="469">                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</span><span data-line="470">                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="471">                    <span class="c1"># vmax = bk.mean(im)+1</span>
</span><span data-line="472">                    <span class="n">_bounds_im</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span>
</span><span data-line="473">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="474">                    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">_bounds_im</span>
</span><span data-line="475">                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
</span><span data-line="476">                    <span class="n">omegas_re</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
</span><span data-line="477">                    <span class="n">omegas_im</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
</span><span data-line="478">                    <span class="n">im</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
</span><span data-line="479">                    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span>
</span><span data-line="480">                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
</span><span data-line="481">                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
</span><span data-line="482">                <span class="p">)</span>
</span><span data-line="483">                <span class="c1"># plt.pause(2)</span>
</span><span data-line="484">                <span class="c1"># plt.colorbar()</span>
</span><span data-line="485">
</span><span data-line="486">            <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="487">                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span data-line="488">            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">min_distance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="489">
</span><span data-line="490">            <span class="n">guess_peak</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">omegas_complex</span><span class="p">[</span><span class="o">*</span><span class="n">coord</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">])</span>
</span><span data-line="491">            <span class="n">tloc</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bk</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">N_guess_loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="492">            <span class="n">guesses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="493">            <span class="k">for</span> <span class="n">guess_loc</span> <span class="ow">in</span> <span class="n">guess_peak</span><span class="p">:</span>
</span><span data-line="494">                <span class="n">guesses_</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="495">                    <span class="n">guess_loc</span><span class="o">.</span><span class="n">real</span>
</span><span data-line="496">                    <span class="o">+</span> <span class="n">Rloc</span> <span class="o">*</span> <span class="n">bk</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tloc</span><span class="p">)</span>
</span><span data-line="497">                    <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">guess_loc</span><span class="o">.</span><span class="n">imag</span> <span class="o">+</span> <span class="n">Rloc</span> <span class="o">*</span> <span class="n">bk</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tloc</span><span class="p">))</span>
</span><span data-line="498">                <span class="p">)</span>
</span><span data-line="499">                <span class="n">guesses_</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">guesses_</span><span class="p">,</span> <span class="n">guess_loc</span><span class="p">])</span>
</span><span data-line="500">                <span class="n">guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">guesses_</span><span class="p">)</span>
</span><span data-line="501">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="502">                <span class="n">guesses</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span data-line="503">        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span data-line="504">            <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span data-line="505">
</span><span data-line="506">            <span class="n">rand_re</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
</span><span data-line="507">            <span class="n">rand_im</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
</span><span data-line="508">            <span class="n">rand_re</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega1</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">omega0</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">*</span> <span class="n">rand_re</span> <span class="o">+</span> <span class="n">omega0</span><span class="o">.</span><span class="n">real</span>
</span><span data-line="509">            <span class="n">rand_im</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega1</span><span class="o">.</span><span class="n">imag</span> <span class="o">-</span> <span class="n">omega0</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">*</span> <span class="n">rand_im</span> <span class="o">+</span> <span class="n">omega0</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="510">            <span class="n">guesses</span> <span class="o">=</span> <span class="n">rand_re</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rand_im</span>
</span><span data-line="511">            <span class="n">guesses</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span data-line="512">
</span><span data-line="513">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="514">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong strategy </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="515">            <span class="c1"># ## linearize</span>
</span><span data-line="516">            <span class="c1"># guesses = []</span>
</span><span data-line="517">            <span class="c1"># for g in guesses0:</span>
</span><span data-line="518">            <span class="c1">#     M = func(g)</span>
</span><span data-line="519">            <span class="c1">#     e = bk.linalg.eigvals(M)</span>
</span><span data-line="520">            <span class="c1">#     srt = bk.argsort(bk.abs(e))</span>
</span><span data-line="521">            <span class="c1">#     guesses.append(e[srt][0])</span>
</span><span data-line="522">            <span class="c1"># guesses = bk.stack(guesses).flatten()</span>
</span><span data-line="523">
</span><span data-line="524">    <span class="n">guesses</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span>
</span><span data-line="525">    <span class="k">if</span> <span class="n">plot_solver</span><span class="p">:</span>
</span><span data-line="526">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="527">            <span class="n">guess_plot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span data-line="528">                <span class="n">guesses</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">guesses</span><span class="o">.</span><span class="n">imag</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;xk&quot;</span>
</span><span data-line="529">            <span class="p">)</span>
</span><span data-line="530">            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Re $\omega/\omega_p$&quot;</span><span class="p">)</span>
</span><span data-line="531">            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Im $\omega/\omega_p$&quot;</span><span class="p">)</span>
</span><span data-line="532">            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span data-line="533">
</span><span data-line="534">    <span class="k">def</span><span class="w"> </span><span class="nf">compute_eigenvalues</span><span class="p">(</span><span class="n">guesses</span><span class="p">,</span> <span class="n">lambda_tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">):</span>
</span><span data-line="535">        <span class="n">evs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="536">        <span class="n">modes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="537">        <span class="n">modes_left</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="538">        <span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="539">        <span class="n">ttot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="540">        <span class="k">for</span> <span class="n">guess</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
</span><span data-line="541">            <span class="k">if</span> <span class="n">init_vect</span> <span class="o">==</span> <span class="s2">&quot;eig&quot;</span><span class="p">:</span>
</span><span data-line="542">                <span class="n">vect_init</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="543">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="544">                <span class="n">vect_init</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">bk</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="545">                <span class="n">vect_init</span> <span class="o">/=</span> <span class="p">(</span><span class="n">vect_init</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">@</span> <span class="n">vect_init</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</span><span data-line="546">
</span><span data-line="547">            <span class="n">t0</span> <span class="o">=</span> <span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="548">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="549">                <span class="n">res</span> <span class="o">=</span> <span class="n">eig_newton</span><span class="p">(</span>
</span><span data-line="550">                    <span class="n">func_eig</span><span class="p">,</span>
</span><span data-line="551">                    <span class="n">guess</span><span class="p">,</span>
</span><span data-line="552">                    <span class="n">vect_init</span><span class="p">,</span>
</span><span data-line="553">                    <span class="n">lambda_tol</span><span class="o">=</span><span class="n">lambda_tol</span><span class="p">,</span>
</span><span data-line="554">                    <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span>
</span><span data-line="555">                    <span class="n">func_gives_der</span><span class="o">=</span><span class="n">func_gives_der</span><span class="p">,</span>
</span><span data-line="556">                    <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
</span><span data-line="557">                <span class="p">)</span>
</span><span data-line="558">            <span class="k">except</span> <span class="n">ConvergenceError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="559">                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span data-line="560">                <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="561">            <span class="n">t0</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="562">            <span class="n">ttot</span> <span class="o">+=</span> <span class="n">t0</span>
</span><span data-line="563">            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="564">                <span class="n">ev</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigval&quot;</span><span class="p">]</span>
</span><span data-line="565">                <span class="c1"># print(res[&quot;iter_count&quot;],res[&quot;delta_lambda&quot;])</span>
</span><span data-line="566">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="567">                    <span class="n">ev</span><span class="o">.</span><span class="n">real</span> <span class="o">&gt;</span> <span class="n">omega0</span><span class="o">.</span><span class="n">real</span>
</span><span data-line="568">                    <span class="ow">and</span> <span class="n">ev</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">omega1</span><span class="o">.</span><span class="n">real</span>
</span><span data-line="569">                    <span class="ow">and</span> <span class="n">ev</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="n">omega1</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="570">                    <span class="ow">and</span> <span class="n">ev</span><span class="o">.</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="n">omega0</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="571">                <span class="p">):</span>
</span><span data-line="572">                    <span class="c1"># if True:</span>
</span><span data-line="573">                    <span class="n">evs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
</span><span data-line="574">                    <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigvec&quot;</span><span class="p">])</span>
</span><span data-line="575">                    <span class="n">modes_left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;eigvec_left&quot;</span><span class="p">])</span>
</span><span data-line="576">                    <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;delta_lambda&quot;</span><span class="p">])</span>
</span><span data-line="577">                    <span class="k">if</span> <span class="n">plot_solver</span><span class="p">:</span>
</span><span data-line="578">                        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">imag</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;.b&quot;</span><span class="p">)</span>
</span><span data-line="579">                        <span class="c1"># plt.xlim(omega0.real, omega1.real)</span>
</span><span data-line="580">                        <span class="c1"># plt.ylim(omega0.imag, omega1.imag)</span>
</span><span data-line="581">                        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
</span><span data-line="582">
</span><span data-line="583">        <span class="k">if</span> <span class="n">evs</span> <span class="o">==</span> <span class="p">[]:</span>
</span><span data-line="584">            <span class="c1"># if plot_solver:</span>
</span><span data-line="585">            <span class="c1">#     try:</span>
</span><span data-line="586">            <span class="c1">#         [_.remove() for _ in guess_plot]</span>
</span><span data-line="587">            <span class="c1">#         plt.pause(0.01)</span>
</span><span data-line="588">            <span class="c1">#     except:</span>
</span><span data-line="589">            <span class="c1">#         pass</span>
</span><span data-line="590">            <span class="k">raise</span> <span class="n">EigenvalueError</span><span class="p">(</span><span class="s2">&quot;No eigenvalues found&quot;</span><span class="p">)</span>
</span><span data-line="591">        <span class="n">evs</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evs</span><span class="p">)</span>
</span><span data-line="592">        <span class="n">modes</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="593">        <span class="n">modes_left</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">modes_left</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="594">        <span class="n">residuals</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</span><span data-line="595">        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
</span><span data-line="596">            <span class="n">unique_indices</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">evs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">lambda_tol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span data-line="597">            <span class="n">modes</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[:,</span> <span class="n">unique_indices</span><span class="p">]</span>
</span><span data-line="598">            <span class="n">modes_left</span> <span class="o">=</span> <span class="n">modes_left</span><span class="p">[:,</span> <span class="n">unique_indices</span><span class="p">]</span>
</span><span data-line="599">            <span class="n">evs</span> <span class="o">=</span> <span class="n">evs</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>
</span><span data-line="600">            <span class="n">residuals</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>
</span><span data-line="601">
</span><span data-line="602">        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span data-line="603">            <span class="n">print_results</span><span class="p">(</span><span class="n">evs</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span>
</span><span data-line="604">
</span><span data-line="605">        <span class="n">srt</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">evs</span><span class="p">))</span>
</span><span data-line="606">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="607">            <span class="k">return</span> <span class="n">evs</span><span class="p">[</span><span class="n">srt</span><span class="p">],</span> <span class="n">modes</span><span class="p">[:,</span> <span class="n">srt</span><span class="p">],</span> <span class="n">modes_left</span><span class="p">[:,</span> <span class="n">srt</span><span class="p">],</span> <span class="n">residuals</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
</span><span data-line="608">        <span class="k">return</span> <span class="n">evs</span><span class="p">[</span><span class="n">srt</span><span class="p">],</span> <span class="n">modes</span><span class="p">[:,</span> <span class="n">srt</span><span class="p">],</span> <span class="n">residuals</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
</span><span data-line="609">
</span><span data-line="610">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="611">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="612">            <span class="n">evs</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">modes_left</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">compute_eigenvalues</span><span class="p">(</span>
</span><span data-line="613">                <span class="n">guesses</span><span class="p">,</span> <span class="n">lambda_tol</span><span class="p">,</span> <span class="n">max_iter</span>
</span><span data-line="614">            <span class="p">)</span>
</span><span data-line="615">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="616">            <span class="n">evs</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">compute_eigenvalues</span><span class="p">(</span><span class="n">guesses</span><span class="p">,</span> <span class="n">lambda_tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">)</span>
</span><span data-line="617">
</span><span data-line="618">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="619">        <span class="k">raise</span> <span class="n">EigenvalueError</span><span class="p">(</span><span class="s2">&quot;No eigenvalues found&quot;</span><span class="p">)</span>
</span><span data-line="620">    <span class="k">if</span> <span class="n">plot_solver</span><span class="p">:</span>
</span><span data-line="621">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="622">            <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">guess_plot</span><span class="p">]</span>
</span><span data-line="623">            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span data-line="624">        <span class="k">except</span><span class="p">:</span>
</span><span data-line="625">            <span class="k">pass</span>
</span><span data-line="626">    <span class="n">tnlevp</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="627">    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span data-line="628">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total time: </span><span class="si">{</span><span class="n">tnlevp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span data-line="629">    <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="630">        <span class="k">return</span> <span class="n">evs</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">modes_left</span>
</span><span data-line="631">    <span class="k">return</span> <span class="n">evs</span><span class="p">,</span> <span class="n">modes</span>
</span><span data-line="632">
</span><span data-line="633">
</span><span data-line="634"><span class="k">def</span><span class="w"> </span><span class="nf">print_results</span><span class="p">(</span><span class="n">evs0</span><span class="p">,</span> <span class="n">res0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="635">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="636">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------&quot;</span><span class="p">)</span>
</span><span data-line="637">    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="638">        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span data-line="639">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">evs0</span><span class="p">)</span><span class="si">}</span><span class="s2"> eigenvalues&quot;</span><span class="p">)</span>
</span><span data-line="640">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------&quot;</span><span class="p">)</span>
</span><span data-line="641">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;              eigenvalue                 residual&quot;</span><span class="p">)</span>
</span><span data-line="642">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------&quot;</span><span class="p">)</span>
</span><span data-line="643">    <span class="k">for</span> <span class="n">z0</span><span class="p">,</span> <span class="n">r0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">evs0</span><span class="p">,</span> <span class="n">res0</span><span class="p">):</span>
</span><span data-line="644">        <span class="n">space</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">z0</span><span class="o">.</span><span class="n">real</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span data-line="645">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">space</span><span class="si">}{</span><span class="n">z0</span><span class="si">:</span><span class="s2">.14f</span><span class="si">}</span><span class="s2">     </span><span class="si">{</span><span class="n">r0</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="646">
</span><span data-line="647">
</span><span data-line="648"><span class="k">def</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">evs</span><span class="p">,</span> <span class="n">precision</span><span class="p">):</span>
</span><span data-line="649">    <span class="n">evs_unique</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="650">    <span class="n">unique_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="651">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evs</span><span class="p">):</span>
</span><span data-line="652">        <span class="n">evfloor</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="653">            <span class="n">bk</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="n">precision</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">bk</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">imag</span> <span class="o">/</span> <span class="n">precision</span><span class="p">)</span>
</span><span data-line="654">        <span class="p">)</span> <span class="o">*</span> <span class="n">precision</span>
</span><span data-line="655">        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">evfloor</span> <span class="ow">in</span> <span class="n">evs_unique</span><span class="p">):</span>
</span><span data-line="656">            <span class="n">evs_unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evfloor</span><span class="p">)</span>
</span><span data-line="657">            <span class="n">unique_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span data-line="658">    <span class="k">return</span> <span class="n">unique_indices</span>
</span><span data-line="659">
</span><span data-line="660">
</span><span data-line="661"><span class="k">def</span><span class="w"> </span><span class="nf">gram_schmidt</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dM</span><span class="p">):</span>
</span><span data-line="662">    <span class="c1"># Get the number of vectors.</span>
</span><span data-line="663"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="664"><span class="sd">    Perform the Gram-Schmidt process on the columns of matrix A.</span>
</span><span data-line="665">
</span><span data-line="666"><span class="sd">    A is a matrix whose columns are the vectors to be orthogonalized.</span>
</span><span data-line="667">
</span><span data-line="668"><span class="sd">    dM is a list of n matrices, where n is the number of columns in A,</span>
</span><span data-line="669"><span class="sd">    and dM[i] is the metric for the i&#39;th column of A.</span>
</span><span data-line="670">
</span><span data-line="671"><span class="sd">    The function returns the matrix A, modified so that its columns are</span>
</span><span data-line="672"><span class="sd">    mutually orthogonal with respect to the metric dM.</span>
</span><span data-line="673">
</span><span data-line="674"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="675">    <span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="676">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span data-line="677">        <span class="c1"># To orthogonalize the vector in column j with respect to the</span>
</span><span data-line="678">        <span class="c1"># previous vectors, subtract from it its projection onto</span>
</span><span data-line="679">        <span class="c1"># each of the previous vectors.</span>
</span><span data-line="680">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
</span><span data-line="681">            <span class="n">A</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">bk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">dM</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">@</span> <span class="n">A</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">A</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
</span><span data-line="682">        <span class="n">A</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dM</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">@</span> <span class="n">A</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
</span><span data-line="683">    <span class="k">return</span> <span class="n">A</span>
</span><span data-line="684">
</span><span data-line="685">
</span><span data-line="686"><span class="k">def</span><span class="w"> </span><span class="nf">_nleigsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">refine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="687"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="688"><span class="sd">    Try to solve the nonlinear eigenvalue problem using _nonlinear_eigensolver.</span>
</span><span data-line="689"><span class="sd">    If it fails, return empty arrays. If refine is True, refine the guesses</span>
</span><span data-line="690"><span class="sd">    and try again.</span>
</span><span data-line="691">
</span><span data-line="692"><span class="sd">    Parameters</span>
</span><span data-line="693"><span class="sd">    ----------</span>
</span><span data-line="694"><span class="sd">    func : callable</span>
</span><span data-line="695"><span class="sd">        Function giving the matrix</span>
</span><span data-line="696"><span class="sd">    dfunc : callable</span>
</span><span data-line="697"><span class="sd">        Function giving the matrix derivative wrt the eigenvalue</span>
</span><span data-line="698"><span class="sd">    *args : arguments</span>
</span><span data-line="699"><span class="sd">        Arguments to be passed to _nonlinear_eigensolver</span>
</span><span data-line="700"><span class="sd">    refine : bool, optional</span>
</span><span data-line="701"><span class="sd">        Refine the guesses and try again if _nonlinear_eigensolver fails?</span>
</span><span data-line="702"><span class="sd">    **kwargs : keyword arguments</span>
</span><span data-line="703"><span class="sd">        Keyword arguments to be passed to _nonlinear_eigensolver</span>
</span><span data-line="704">
</span><span data-line="705"><span class="sd">    Returns</span>
</span><span data-line="706"><span class="sd">    -------</span>
</span><span data-line="707"><span class="sd">    evs : array</span>
</span><span data-line="708"><span class="sd">        The eigenvalues</span>
</span><span data-line="709"><span class="sd">    eigenvectors : array</span>
</span><span data-line="710"><span class="sd">        The eigenvectors</span>
</span><span data-line="711"><span class="sd">    eigenvectors_left : array, optional</span>
</span><span data-line="712"><span class="sd">        The left eigenvectors</span>
</span><span data-line="713"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="714">    <span class="n">return_left</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;return_left&quot;</span><span class="p">]</span>
</span><span data-line="715">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="716">        <span class="n">out</span> <span class="o">=</span> <span class="n">_nonlinear_eigensolver</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="717">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="718">            <span class="n">evs0</span><span class="p">,</span> <span class="n">eigenvectors0</span><span class="p">,</span> <span class="n">eigenvectors_left0</span> <span class="o">=</span> <span class="n">out</span>
</span><span data-line="719">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="720">            <span class="n">evs0</span><span class="p">,</span> <span class="n">eigenvectors0</span> <span class="o">=</span> <span class="n">out</span>
</span><span data-line="721">        <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
</span><span data-line="722">            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;guesses&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evs0</span>
</span><span data-line="723">            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lambda_tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lambda_tol&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1e-14</span><span class="p">)</span>
</span><span data-line="724">            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span data-line="725">            <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="726">                <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">eigenvectors_left</span> <span class="o">=</span> <span class="n">_nonlinear_eigensolver</span><span class="p">(</span>
</span><span data-line="727">                    <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="728">                <span class="p">)</span>
</span><span data-line="729">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="730">                <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">_nonlinear_eigensolver</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="731">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="732">            <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="733">                <span class="k">return</span> <span class="n">evs0</span><span class="p">,</span> <span class="n">eigenvectors0</span><span class="p">,</span> <span class="n">eigenvectors_left0</span>
</span><span data-line="734">            <span class="k">return</span> <span class="n">evs0</span><span class="p">,</span> <span class="n">eigenvectors0</span>
</span><span data-line="735">    <span class="k">except</span> <span class="n">EigenvalueError</span><span class="p">:</span>
</span><span data-line="736">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="737">            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span data-line="738">        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span data-line="739">    <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="740">        <span class="k">return</span> <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">eigenvectors_left</span>
</span><span data-line="741">    <span class="k">return</span> <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span>
</span><span data-line="742">
</span><span data-line="743">
</span><span data-line="744"><span class="k">def</span><span class="w"> </span><span class="nf">plot_rectangle</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="745"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="746"><span class="sd">    Plot a rectangle on a given axes.</span>
</span><span data-line="747">
</span><span data-line="748"><span class="sd">    Parameters</span>
</span><span data-line="749"><span class="sd">    ----------</span>
</span><span data-line="750"><span class="sd">    ax : Axes</span>
</span><span data-line="751"><span class="sd">        The axes to plot on</span>
</span><span data-line="752"><span class="sd">    z0, z1 : complex</span>
</span><span data-line="753"><span class="sd">        The corners of the rectangle, given in complex coordinates</span>
</span><span data-line="754"><span class="sd">    **kwargs : optional</span>
</span><span data-line="755"><span class="sd">        Any additional keyword arguments are passed to `patches.Rectangle`</span>
</span><span data-line="756">
</span><span data-line="757"><span class="sd">    Returns</span>
</span><span data-line="758"><span class="sd">    -------</span>
</span><span data-line="759"><span class="sd">    patch : patches.Rectangle</span>
</span><span data-line="760"><span class="sd">        The plotted rectangle</span>
</span><span data-line="761"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="762">    <span class="n">patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span data-line="763">        <span class="p">(</span><span class="n">z0</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">z0</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span>  <span class="c1"># (x,y)</span>
</span><span data-line="764">        <span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>  <span class="c1"># width</span>
</span><span data-line="765">        <span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>  <span class="c1"># height</span>
</span><span data-line="766">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="767">    <span class="p">)</span>
</span><span data-line="768">    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
</span><span data-line="769">    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span data-line="770">    <span class="k">return</span> <span class="n">patch</span>
</span><span data-line="771">
</span><span data-line="772">
</span><span data-line="773"><span class="k">def</span><span class="w"> </span><span class="nf">cut_rectangle_in_four</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">ratio_re</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ratio_im</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span data-line="774"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="775"><span class="sd">    Cut a rectangle in four parts.</span>
</span><span data-line="776">
</span><span data-line="777"><span class="sd">    Parameters</span>
</span><span data-line="778"><span class="sd">    ----------</span>
</span><span data-line="779"><span class="sd">    z0, z1 : complex</span>
</span><span data-line="780"><span class="sd">        The lower left and upper right corners of the rectangle</span>
</span><span data-line="781"><span class="sd">    ratio_re, ratio_im : float, optional</span>
</span><span data-line="782"><span class="sd">        The ratio of the width and height of the middle rectangle</span>
</span><span data-line="783"><span class="sd">        to the width and height of the whole rectangle. By default,</span>
</span><span data-line="784"><span class="sd">        the ratio is 0.5.</span>
</span><span data-line="785">
</span><span data-line="786"><span class="sd">    Returns</span>
</span><span data-line="787"><span class="sd">    -------</span>
</span><span data-line="788"><span class="sd">    four_rectangles : tuple of four tuples</span>
</span><span data-line="789"><span class="sd">        The four rectangles, each as a tuple of two complex numbers</span>
</span><span data-line="790"><span class="sd">        (lower left and upper right corners)</span>
</span><span data-line="791"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="792">    <span class="n">xmid</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">ratio_re</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">z0</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
</span><span data-line="793">    <span class="n">ymid</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">imag</span> <span class="o">+</span> <span class="n">ratio_im</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span><span class="o">.</span><span class="n">imag</span> <span class="o">-</span> <span class="n">z0</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
</span><span data-line="794">    <span class="n">zmid</span> <span class="o">=</span> <span class="n">xmid</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">ymid</span>
</span><span data-line="795">    <span class="n">zbot</span> <span class="o">=</span> <span class="n">xmid</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">z0</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="796">    <span class="n">ztop</span> <span class="o">=</span> <span class="n">xmid</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">z1</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="797">    <span class="n">zleft</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">ymid</span>
</span><span data-line="798">    <span class="n">zright</span> <span class="o">=</span> <span class="n">z1</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">ymid</span>
</span><span data-line="799">    <span class="k">return</span> <span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">zmid</span><span class="p">),</span> <span class="p">(</span><span class="n">zbot</span><span class="p">,</span> <span class="n">zright</span><span class="p">),</span> <span class="p">(</span><span class="n">zmid</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">zleft</span><span class="p">,</span> <span class="n">ztop</span><span class="p">)</span>
</span><span data-line="800">
</span><span data-line="801">
</span><span data-line="802"><span class="k">def</span><span class="w"> </span><span class="nf">_nleigsolve_recursive</span><span class="p">(</span>
</span><span data-line="803">    <span class="n">func</span><span class="p">,</span>
</span><span data-line="804">    <span class="n">omega0</span><span class="p">,</span>
</span><span data-line="805">    <span class="n">omega1</span><span class="p">,</span>
</span><span data-line="806">    <span class="n">evs_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="807">    <span class="n">eigenvectors_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="808">    <span class="n">eigenvectors_left_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="809">    <span class="n">Ncutmax</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span data-line="810">    <span class="n">Ncut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span data-line="811">    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="812"><span class="p">):</span>
</span><span data-line="813"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="814"><span class="sd">    Recursive version of _nleigsolve.</span>
</span><span data-line="815">
</span><span data-line="816"><span class="sd">    Parameters</span>
</span><span data-line="817"><span class="sd">    ----------</span>
</span><span data-line="818"><span class="sd">    func : callable</span>
</span><span data-line="819"><span class="sd">        Function giving the matrix</span>
</span><span data-line="820"><span class="sd">    dfunc : callable</span>
</span><span data-line="821"><span class="sd">        Function giving the matrix derivative wrt the eigenvalue</span>
</span><span data-line="822"><span class="sd">    omega0, omega1 : complex</span>
</span><span data-line="823"><span class="sd">        The lower left and upper right corners of the rectangle</span>
</span><span data-line="824"><span class="sd">    evs_ : list of array, optional</span>
</span><span data-line="825"><span class="sd">        The eigenvalues found so far</span>
</span><span data-line="826"><span class="sd">    eigenvectors_ : list of array, optional</span>
</span><span data-line="827"><span class="sd">        The eigenvectors found so far</span>
</span><span data-line="828"><span class="sd">    eigenvectors_left_ : list of array, optional</span>
</span><span data-line="829"><span class="sd">        The left eigenvectors found so far</span>
</span><span data-line="830"><span class="sd">    Ncutmax : int, optional</span>
</span><span data-line="831"><span class="sd">        The maximum number of recursive calls</span>
</span><span data-line="832"><span class="sd">    Ncut : int, optional</span>
</span><span data-line="833"><span class="sd">        The current number of recursive calls</span>
</span><span data-line="834"><span class="sd">    **kwargs : keyword arguments</span>
</span><span data-line="835"><span class="sd">        Keyword arguments to be passed to _nleigsolve</span>
</span><span data-line="836">
</span><span data-line="837"><span class="sd">    Returns</span>
</span><span data-line="838"><span class="sd">    -------</span>
</span><span data-line="839"><span class="sd">    evs_ : list of array</span>
</span><span data-line="840"><span class="sd">        The eigenvalues found</span>
</span><span data-line="841"><span class="sd">    eigenvectors_ : list of array</span>
</span><span data-line="842"><span class="sd">        The eigenvectors found</span>
</span><span data-line="843"><span class="sd">    eigenvectors_left_ : list of array, optional</span>
</span><span data-line="844"><span class="sd">        The left eigenvectors found</span>
</span><span data-line="845"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="846">    <span class="k">if</span> <span class="n">evs_</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="847">        <span class="n">evs_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="848">    <span class="k">if</span> <span class="n">eigenvectors_</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="849">        <span class="n">eigenvectors_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="850">    <span class="k">if</span> <span class="n">eigenvectors_left_</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="851">        <span class="n">eigenvectors_left_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="852">    <span class="n">Ncut</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="853">
</span><span data-line="854">    <span class="n">return_left</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;return_left&quot;</span><span class="p">]</span>
</span><span data-line="855">
</span><span data-line="856">    <span class="n">peak_ref0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;peak_ref&quot;</span><span class="p">]</span>
</span><span data-line="857">    <span class="n">evs_old</span> <span class="o">=</span> <span class="n">evs_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="858">    <span class="k">if</span> <span class="n">evs_old</span> <span class="o">!=</span> <span class="p">[]:</span>
</span><span data-line="859">        <span class="n">_evs0</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">evs_old</span><span class="p">)</span> <span class="k">if</span> <span class="n">evs_old</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">evs_old</span>
</span><span data-line="860">        <span class="n">unique_indices0</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">_evs0</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lambda_tol&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span data-line="861">        <span class="n">Nmodes0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_indices0</span><span class="p">)</span>
</span><span data-line="862">        <span class="n">Nmodes_in_region</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="863">        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_evs0</span><span class="p">[</span><span class="n">unique_indices0</span><span class="p">]:</span>
</span><span data-line="864">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="865">                <span class="n">e</span><span class="o">.</span><span class="n">real</span> <span class="o">&gt;</span> <span class="n">omega0</span><span class="o">.</span><span class="n">real</span>
</span><span data-line="866">                <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="n">omega0</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="867">                <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="n">omega1</span><span class="o">.</span><span class="n">real</span>
</span><span data-line="868">                <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="n">omega1</span><span class="o">.</span><span class="n">imag</span>
</span><span data-line="869">            <span class="p">):</span>
</span><span data-line="870">                <span class="n">Nmodes_in_region</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="871">        <span class="n">N_grid_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;N_grid&quot;</span><span class="p">])</span>
</span><span data-line="872">        <span class="n">peak_ref1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nmodes_in_region</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">peak_ref0</span>
</span><span data-line="873">
</span><span data-line="874">        <span class="n">peak_ref1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">peak_ref0</span><span class="p">,</span> <span class="n">peak_ref1</span><span class="p">)</span>
</span><span data-line="875">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="876">        <span class="n">Nmodes0</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="877">        <span class="n">Nmodes_in_region</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="878">        <span class="n">peak_ref1</span> <span class="o">=</span> <span class="n">peak_ref0</span>
</span><span data-line="879">    <span class="n">peak_ref1</span> <span class="o">=</span> <span class="n">peak_ref0</span>  <span class="c1"># max(peak_ref1, 4*peak_ref0)</span>
</span><span data-line="880">
</span><span data-line="881">    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plot_solver&quot;</span><span class="p">]:</span>
</span><span data-line="882">        <span class="n">rectplot</span> <span class="o">=</span> <span class="n">plot_rectangle</span><span class="p">(</span>
</span><span data-line="883">            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
</span><span data-line="884">            <span class="n">omega0</span> <span class="o">/</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
</span><span data-line="885">            <span class="n">omega1</span> <span class="o">/</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
</span><span data-line="886">            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="887">            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="888">            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#d8ff3d&quot;</span><span class="p">,</span>
</span><span data-line="889">            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span data-line="890">            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#ff7c24&quot;</span><span class="p">,</span>
</span><span data-line="891">        <span class="p">)</span>
</span><span data-line="892">        <span class="n">rectplot1</span> <span class="o">=</span> <span class="n">plot_rectangle</span><span class="p">(</span>
</span><span data-line="893">            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
</span><span data-line="894">            <span class="n">omega0</span> <span class="o">/</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
</span><span data-line="895">            <span class="n">omega1</span> <span class="o">/</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
</span><span data-line="896">            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="897">            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="898">            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span data-line="899">            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#ff7c24&quot;</span><span class="p">,</span>
</span><span data-line="900">        <span class="p">)</span>
</span><span data-line="901">        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
</span><span data-line="902">
</span><span data-line="903">    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;peak_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_ref1</span>
</span><span data-line="904">    <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="905">        <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">eigenvectors_left</span> <span class="o">=</span> <span class="n">_nleigsolve</span><span class="p">(</span>
</span><span data-line="906">            <span class="n">func</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="907">        <span class="p">)</span>
</span><span data-line="908">
</span><span data-line="909">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="910">        <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">_nleigsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="911">
</span><span data-line="912">    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;peak_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_ref0</span>
</span><span data-line="913">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="914">        <span class="n">evs_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evs</span><span class="p">)</span>
</span><span data-line="915">        <span class="n">eigenvectors_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">)</span>
</span><span data-line="916">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="917">            <span class="n">eigenvectors_left_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eigenvectors_left</span><span class="p">)</span>
</span><span data-line="918">
</span><span data-line="919">    <span class="k">if</span> <span class="n">evs_old</span> <span class="o">!=</span> <span class="p">[]:</span>
</span><span data-line="920">        <span class="n">_evs1</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">evs_</span><span class="p">)</span>
</span><span data-line="921">        <span class="n">unique_indices1</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">_evs1</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lambda_tol&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span data-line="922">        <span class="n">cond</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_indices0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_indices1</span><span class="p">)</span>
</span><span data-line="923">        <span class="c1"># evs_ = [_evs1[i] for i in unique_indices1]</span>
</span><span data-line="924">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="925">        <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="926">
</span><span data-line="927">    <span class="c1"># cond = bk.all([e in bk.hstack(evs_old) for e in evs]) if evs_old !=[] else False</span>
</span><span data-line="928">    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plot_solver&quot;</span><span class="p">]:</span>
</span><span data-line="929">        <span class="n">rectplot</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span data-line="930">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cond</span><span class="p">:</span>
</span><span data-line="931">        <span class="n">cut</span> <span class="o">=</span> <span class="n">cut_in_four</span><span class="p">(</span><span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span data-line="932">        <span class="k">for</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="n">cut</span><span class="p">:</span>
</span><span data-line="933">            <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span> <span class="o">=</span> <span class="n">bounds</span>
</span><span data-line="934">            <span class="n">out</span> <span class="o">=</span> <span class="n">_nleigsolve_recursive</span><span class="p">(</span>
</span><span data-line="935">                <span class="n">func</span><span class="p">,</span>
</span><span data-line="936">                <span class="n">omega0</span><span class="p">,</span>
</span><span data-line="937">                <span class="n">omega1</span><span class="p">,</span>
</span><span data-line="938">                <span class="n">evs_</span><span class="p">,</span>
</span><span data-line="939">                <span class="n">eigenvectors_</span><span class="p">,</span>
</span><span data-line="940">                <span class="n">eigenvectors_left_</span><span class="p">,</span>
</span><span data-line="941">                <span class="n">Ncutmax</span><span class="o">=</span><span class="n">Ncutmax</span><span class="p">,</span>
</span><span data-line="942">                <span class="n">Ncut</span><span class="o">=</span><span class="n">Ncut</span><span class="p">,</span>
</span><span data-line="943">                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="944">            <span class="p">)</span>
</span><span data-line="945">            <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="946">                <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span> <span class="o">=</span> <span class="n">out</span>
</span><span data-line="947">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="948">                <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span> <span class="o">=</span> <span class="n">out</span>
</span><span data-line="949">
</span><span data-line="950">    <span class="k">if</span> <span class="n">Ncut</span> <span class="o">&gt;</span> <span class="n">Ncutmax</span><span class="p">:</span>
</span><span data-line="951">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="952">            <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span>
</span><span data-line="953">        <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span>
</span><span data-line="954">    <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="955">        <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span>
</span><span data-line="956">    <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span>
</span><span data-line="957">
</span><span data-line="958">
<div class="viewcode-block" id="nonlinear_eigensolver">
<a class="viewcode-back" href="../../autoapi/pytmod/eig/index.html#pytmod.eig.nonlinear_eigensolver">[docs]</a>
</span><span data-line="959"><span class="k">def</span><span class="w"> </span><span class="nf">nonlinear_eigensolver</span><span class="p">(</span>
</span><span data-line="960">    <span class="n">func</span><span class="p">,</span>
</span><span data-line="961">    <span class="n">omega0</span><span class="p">,</span>
</span><span data-line="962">    <span class="n">omega1</span><span class="p">,</span>
</span><span data-line="963">    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="964"><span class="p">):</span>
</span><span data-line="965"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="966"><span class="sd">    Find eigenvalues and eigenvectors of a nonlinear eigenvalue problem.</span>
</span><span data-line="967">
</span><span data-line="968"><span class="sd">    Parameters</span>
</span><span data-line="969"><span class="sd">    ----------</span>
</span><span data-line="970"><span class="sd">    func : callable</span>
</span><span data-line="971"><span class="sd">        Function giving the matrix</span>
</span><span data-line="972"><span class="sd">    omega0 : complex</span>
</span><span data-line="973"><span class="sd">        Lower bound of the frequency interval</span>
</span><span data-line="974"><span class="sd">    omega1 : complex</span>
</span><span data-line="975"><span class="sd">        Upper bound of the frequency interval</span>
</span><span data-line="976"><span class="sd">    **kwargs : keyword arguments</span>
</span><span data-line="977"><span class="sd">        See `defkwargs` below.</span>
</span><span data-line="978">
</span><span data-line="979"><span class="sd">    Returns</span>
</span><span data-line="980"><span class="sd">    -------</span>
</span><span data-line="981"><span class="sd">    evs : array</span>
</span><span data-line="982"><span class="sd">        The eigenvalues</span>
</span><span data-line="983"><span class="sd">    eigenvectors : array</span>
</span><span data-line="984"><span class="sd">        The eigenvectors</span>
</span><span data-line="985"><span class="sd">    eigenvectors_left : array, optional</span>
</span><span data-line="986"><span class="sd">        The left eigenvectors.</span>
</span><span data-line="987">
</span><span data-line="988"><span class="sd">    Notes</span>
</span><span data-line="989"><span class="sd">    -----</span>
</span><span data-line="990"><span class="sd">    The function uses a combination of grid search and Newton iterations to</span>
</span><span data-line="991"><span class="sd">    find the eigenvalues and eigenvectors of the nonlinear eigenvalue problem.</span>
</span><span data-line="992"><span class="sd">    If `recursive` is `True`, the function refines the guesses by dividing the</span>
</span><span data-line="993"><span class="sd">    frequency interval in four parts and solving the problem recursively.</span>
</span><span data-line="994"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="995">    <span class="n">defkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span data-line="996">        <span class="n">dfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="997">        <span class="n">guesses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="998">        <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="999">        <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;max element&quot;</span><span class="p">,</span>
</span><span data-line="1000">        <span class="n">init_vect</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span>
</span><span data-line="1001">        <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;peaks&quot;</span><span class="p">,</span>
</span><span data-line="1002">        <span class="n">peaks_estimate</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span>
</span><span data-line="1003">        <span class="n">lambda_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
</span><span data-line="1004">        <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span data-line="1005">        <span class="n">N_grid</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
</span><span data-line="1006">        <span class="n">N_guess_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span data-line="1007">        <span class="n">Rloc</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span data-line="1008">        <span class="n">plot_solver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1009">        <span class="n">peak_ref</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span data-line="1010">        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1011">        <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1012">        <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="1013">        <span class="n">return_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1014">    <span class="p">)</span>
</span><span data-line="1015">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defkwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1016">        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span data-line="1017">            <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span data-line="1018">
</span><span data-line="1019">    <span class="n">return_left</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;return_left&quot;</span><span class="p">]</span>
</span><span data-line="1020">    <span class="n">recursive</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;recursive&quot;</span><span class="p">]</span>
</span><span data-line="1021">    <span class="c1"># dfunc = kwargs[&quot;dfunc&quot;]</span>
</span><span data-line="1022">    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
</span><span data-line="1023">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1024">            <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span> <span class="o">=</span> <span class="n">_nleigsolve_recursive</span><span class="p">(</span>
</span><span data-line="1025">                <span class="n">func</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1026">            <span class="p">)</span>
</span><span data-line="1027">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1028">            <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span> <span class="o">=</span> <span class="n">_nleigsolve_recursive</span><span class="p">(</span>
</span><span data-line="1029">                <span class="n">func</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1030">            <span class="p">)</span>
</span><span data-line="1031">
</span><span data-line="1032">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1033">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1034">            <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span> <span class="o">=</span> <span class="n">_nleigsolve</span><span class="p">(</span>
</span><span data-line="1035">                <span class="n">func</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1036">            <span class="p">)</span>
</span><span data-line="1037">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1038">            <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span> <span class="o">=</span> <span class="n">_nleigsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">omega0</span><span class="p">,</span> <span class="n">omega1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1039">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evs_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1040">            <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1041">                <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span>
</span><span data-line="1042">            <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span>
</span><span data-line="1043">        <span class="c1"># eigenvectors_ = [eigenvectors_]</span>
</span><span data-line="1044">        <span class="c1"># evs_ = [evs_]</span>
</span><span data-line="1045">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evs_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1046">        <span class="k">if</span> <span class="ow">not</span> <span class="n">recursive</span><span class="p">:</span>
</span><span data-line="1047">            <span class="n">eigenvectors_</span> <span class="o">=</span> <span class="p">[</span><span class="n">eigenvectors_</span><span class="p">]</span>
</span><span data-line="1048">            <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1049">                <span class="n">eigenvectors_left_</span> <span class="o">=</span> <span class="p">[</span><span class="n">eigenvectors_left_</span><span class="p">]</span>
</span><span data-line="1050">            <span class="n">evs_</span> <span class="o">=</span> <span class="p">[</span><span class="n">evs_</span><span class="p">]</span>
</span><span data-line="1051">        <span class="n">evs</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">evs_</span><span class="p">)</span>
</span><span data-line="1052">        <span class="n">unique_indices</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">evs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lambda_tol&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span data-line="1053">        <span class="n">evs</span> <span class="o">=</span> <span class="n">evs</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>
</span><span data-line="1054">        <span class="n">isort</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">evs</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
</span><span data-line="1055">        <span class="n">evs</span> <span class="o">=</span> <span class="n">evs</span><span class="p">[</span><span class="n">isort</span><span class="p">]</span>
</span><span data-line="1056">        <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">eigenvectors_</span><span class="p">)[:,</span> <span class="n">unique_indices</span><span class="p">][:,</span> <span class="n">isort</span><span class="p">]</span>
</span><span data-line="1057">
</span><span data-line="1058">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1059">            <span class="n">eigenvectors_left</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">eigenvectors_left_</span><span class="p">)[:,</span> <span class="n">unique_indices</span><span class="p">][</span>
</span><span data-line="1060">                <span class="p">:,</span> <span class="n">isort</span>
</span><span data-line="1061">            <span class="p">]</span>
</span><span data-line="1062">
</span><span data-line="1063">        <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1064">            <span class="k">return</span> <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">eigenvectors_left</span>
</span><span data-line="1065">        <span class="k">return</span> <span class="n">evs</span><span class="p">,</span> <span class="n">eigenvectors</span>
</span><span data-line="1066">    <span class="k">if</span> <span class="n">return_left</span><span class="p">:</span>
</span><span data-line="1067">        <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span><span class="p">,</span> <span class="n">eigenvectors_left_</span>
</span><span data-line="1068">    <span class="k">return</span> <span class="n">evs_</span><span class="p">,</span> <span class="n">eigenvectors_</span></div>

</span><span data-line="1069">
</span><span data-line="1070">
</span><span data-line="1071"><span class="k">def</span><span class="w"> </span><span class="nf">polyeig</span><span class="p">(</span><span class="o">*</span><span class="n">A</span><span class="p">):</span>
</span><span data-line="1072"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve the polynomial eigenvalue problem: (A0 + e A1 +...+  e**p Ap)x=0</span>
</span><span data-line="1073">
</span><span data-line="1074"><span class="sd">    Parameters</span>
</span><span data-line="1075"><span class="sd">    ----------</span>
</span><span data-line="1076"><span class="sd">    A : list of arrays</span>
</span><span data-line="1077"><span class="sd">        The arrays for each power of the polynomial (in increasing order)</span>
</span><span data-line="1078">
</span><span data-line="1079"><span class="sd">    Returns</span>
</span><span data-line="1080"><span class="sd">    -------</span>
</span><span data-line="1081"><span class="sd">    tuple of arrays</span>
</span><span data-line="1082"><span class="sd">        eigenvalues e and eigenvectors x</span>
</span><span data-line="1083">
</span><span data-line="1084"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1085">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1086">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Provide at least one matrix&quot;</span><span class="p">)</span>
</span><span data-line="1087">    <span class="k">for</span> <span class="n">Ai</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>
</span><span data-line="1088">        <span class="k">if</span> <span class="n">Ai</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Ai</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span data-line="1089">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Matrices must be square&quot;</span><span class="p">)</span>
</span><span data-line="1090">        <span class="k">if</span> <span class="n">Ai</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span data-line="1091">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;All matrices must have the same shapes&quot;</span><span class="p">)</span>
</span><span data-line="1092">
</span><span data-line="1093">    <span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1094">    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="1095">    <span class="c1"># Assemble matrices for generalized problem</span>
</span><span data-line="1096">    <span class="n">C</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span>
</span><span data-line="1097">        <span class="p">[[</span><span class="n">bk</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)),</span> <span class="n">bk</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))],</span> <span class="p">[</span><span class="o">-</span><span class="n">bk</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]]</span>
</span><span data-line="1098">    <span class="p">)</span>
</span><span data-line="1099">    <span class="n">D</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span>
</span><span data-line="1100">        <span class="p">[</span>
</span><span data-line="1101">            <span class="p">[</span><span class="n">bk</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">bk</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">))],</span>
</span><span data-line="1102">            <span class="p">[</span><span class="n">bk</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span> <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
</span><span data-line="1103">        <span class="p">]</span>
</span><span data-line="1104">    <span class="p">)</span>
</span><span data-line="1105">    <span class="c1"># Solve generalized eigenvalue problem</span>
</span><span data-line="1106">    <span class="n">e</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="1107">    <span class="k">if</span> <span class="n">bk</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">e</span><span class="p">)):</span>
</span><span data-line="1108">        <span class="n">e</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span data-line="1109">    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
</span><span data-line="1110">
</span><span data-line="1111">    <span class="c1"># Sort eigenvalues/vectors</span>
</span><span data-line="1112">    <span class="c1"># I = bk.argsort(e)</span>
</span><span data-line="1113">    <span class="c1"># X = X[:,I]</span>
</span><span data-line="1114">    <span class="c1"># e = e[I]</span>
</span><span data-line="1115">
</span><span data-line="1116">    <span class="c1"># Scaling each mode by max</span>
</span><span data-line="1117">    <span class="n">maxi</span> <span class="o">=</span> <span class="n">bk</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1118">
</span><span data-line="1119">    <span class="k">if</span> <span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
</span><span data-line="1120">        <span class="n">maxi</span> <span class="o">=</span> <span class="n">maxi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1121">    <span class="n">X</span> <span class="o">/=</span> <span class="n">bk</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">maxi</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span data-line="1122">
</span><span data-line="1123">    <span class="k">return</span> <span class="n">e</span><span class="p">,</span> <span class="n">X</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Benjamin Vial</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/benvial/pytmod" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=55e26b35"></script></body>
</html>